<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”Œ</text></svg>" />
    <title>Web2API Catalog</title>
    <style>
      :root {
        --bg-1: #f6f2e7;
        --bg-2: #ede3cf;
        --paper: #fffdf6;
        --ink: #1b2a2e;
        --ink-dim: #5b6a72;
        --teal-900: #114f55;
        --teal-700: #1e6c74;
        --teal-100: #d8eceb;
        --amber: #f0aa2d;
        --line: #d8cfbf;
        --shadow-soft: 0 14px 30px rgba(20, 35, 40, 0.08);
        --shadow-strong: 0 20px 40px rgba(20, 35, 40, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: "Gill Sans", "Trebuchet MS", "Lucida Sans Unicode", sans-serif;
        background:
          radial-gradient(circle at 0% 0%, rgba(240, 170, 45, 0.2), transparent 32%),
          radial-gradient(circle at 100% 0%, rgba(17, 79, 85, 0.2), transparent 30%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
      }

      .page {
        width: min(1180px, calc(100% - 2rem));
        margin: 1.5rem auto 2.7rem;
      }

      .hero {
        border: 1px solid rgba(17, 79, 85, 0.2);
        border-radius: 12px;
        padding: 1.1rem;
        background: linear-gradient(130deg, rgba(255, 253, 246, 0.94), rgba(239, 249, 248, 0.78));
        box-shadow: var(--shadow-soft);
        animation: lift-in 420ms ease both;
      }

      .hero-tag {
        display: inline-block;
        margin-bottom: 0.5rem;
        padding: 0.18rem 0.5rem;
        border-radius: 999px;
        border: 1px solid rgba(17, 79, 85, 0.25);
        color: var(--teal-900);
        background: var(--teal-100);
        text-transform: uppercase;
        font-size: 0.72rem;
        letter-spacing: 0.08em;
      }

      h1 {
        margin: 0;
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: clamp(1.8rem, 2.8vw, 2.6rem);
      }

      .subtitle {
        margin: 0.45rem 0 0;
        color: var(--ink-dim);
        line-height: 1.5;
        max-width: 76ch;
      }

      .subtitle code {
        padding: 0.1rem 0.3rem;
        border-radius: 0.35rem;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        color: var(--teal-900);
        background: rgba(17, 79, 85, 0.12);
      }

      .toolbar {
        margin-top: 0.95rem;
        display: grid;
        grid-template-columns: minmax(240px, 1fr) auto;
        gap: 0.6rem;
        align-items: center;
      }

      .filter {
        width: 100%;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--ink);
        border-radius: 9px;
        padding: 0.62rem 0.72rem;
        font-size: 0.95rem;
      }

      .filter:focus {
        outline: 2px solid rgba(30, 108, 116, 0.35);
        outline-offset: 1px;
        border-color: rgba(30, 108, 116, 0.45);
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.42rem;
        border: 1px solid var(--line);
        border-radius: 9px;
        padding: 0.48rem 0.58rem;
        font-size: 0.84rem;
        color: #34444b;
        background: rgba(255, 255, 255, 0.84);
      }

      .toggle input {
        accent-color: var(--teal-700);
      }

      .summary {
        margin-top: 0.65rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.18rem 0.5rem;
        border: 1px solid var(--line);
        border-radius: 999px;
        font-size: 0.79rem;
        color: #34444b;
        background: rgba(255, 255, 255, 0.84);
      }

      .pill strong {
        color: var(--teal-900);
      }

      .catalog {
        margin-top: 1rem;
      }

      .head {
        display: grid;
        grid-template-columns: minmax(220px, 1.2fr) minmax(220px, 1.2fr) minmax(300px, 1.7fr);
        gap: 0.8rem;
        align-items: center;
        margin-bottom: 0.38rem;
        padding: 0 0.52rem;
      }

      .head span {
        color: #5f7078;
        font-size: 0.72rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .row {
        border: 1px solid var(--line);
        border-radius: 9px;
        background: var(--paper);
        box-shadow: 0 8px 18px rgba(20, 35, 40, 0.06);
        padding: 0.74rem;
        display: grid;
        grid-template-columns: minmax(220px, 1.2fr) minmax(220px, 1.2fr) minmax(300px, 1.7fr);
        gap: 0.8rem;
        align-items: start;
        margin-bottom: 0.54rem;
        animation: lift-in 360ms ease both;
        animation-delay: calc(var(--row-index, 0) * 42ms);
      }

      .row:hover {
        border-color: rgba(17, 79, 85, 0.35);
        box-shadow: var(--shadow-strong);
        transform: translateX(2px);
      }

      .row.is-hidden {
        display: none;
      }

      .site {
        min-width: 0;
      }

      .site h2 {
        margin: 0;
        font-size: 1.12rem;
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      }

      .slug {
        display: inline-block;
        margin-top: 0.25rem;
        border: 1px solid rgba(17, 79, 85, 0.25);
        border-radius: 0.4rem;
        padding: 0.08rem 0.36rem;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        font-size: 0.76rem;
        color: var(--teal-900);
        background: var(--teal-100);
      }

      .desc {
        margin: 0.46rem 0 0;
        color: var(--ink-dim);
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .endpoints,
      .urls {
        min-width: 0;
        display: grid;
        gap: 0.42rem;
      }

      .endpoint-item {
        border: 1px solid rgba(17, 79, 85, 0.15);
        border-radius: 0.52rem;
        padding: 0.34rem 0.45rem;
        background: rgba(17, 79, 85, 0.04);
      }

      .endpoint-item.is-hidden,
      .url-item.is-hidden {
        display: none;
      }

      .endpoint-top {
        display: flex;
        align-items: center;
        gap: 0.34rem;
      }

      .ep-name {
        margin: 0;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        font-size: 0.78rem;
        color: var(--teal-900);
      }

      .q-badge {
        border: 1px solid rgba(240, 170, 45, 0.45);
        border-radius: 999px;
        padding: 0.08rem 0.34rem;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        font-size: 0.66rem;
        color: #7b4a00;
        background: rgba(240, 170, 45, 0.22);
      }

      .ep-desc {
        margin: 0.24rem 0 0;
        color: #5f7078;
        font-size: 0.8rem;
        line-height: 1.35;
      }

      .url-item {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 0.35rem;
      }

      .url {
        display: block;
        text-decoration: none;
        border: 1px solid rgba(17, 79, 85, 0.2);
        border-radius: 0.52rem;
        background: rgba(17, 79, 85, 0.06);
        color: #114b52;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        font-size: 0.74rem;
        padding: 0.36rem 0.42rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .url:hover {
        background: rgba(17, 79, 85, 0.12);
        border-color: rgba(17, 79, 85, 0.4);
      }

      .copy-btn {
        border: 1px solid rgba(17, 79, 85, 0.28);
        border-radius: 0.52rem;
        background: #fff;
        color: #24545a;
        font-size: 0.74rem;
        padding: 0.22rem 0.5rem;
        cursor: pointer;
      }

      .copy-btn:hover {
        border-color: rgba(17, 79, 85, 0.48);
        background: rgba(17, 79, 85, 0.08);
      }

      .copy-btn:focus-visible {
        outline: 2px solid rgba(30, 108, 116, 0.45);
        outline-offset: 1px;
      }

      .empty {
        margin-top: 0.9rem;
        border: 1px dashed rgba(17, 79, 85, 0.35);
        border-radius: 9px;
        background: rgba(255, 255, 255, 0.66);
        color: var(--ink-dim);
        padding: 1rem;
      }

      .empty.is-hidden {
        display: none;
      }

      .manager {
        margin-top: 1.2rem;
        border: 1px solid rgba(17, 79, 85, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.86);
        box-shadow: var(--shadow-soft);
        padding: 0.82rem;
      }

      .manager-top {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: 1fr auto;
        align-items: center;
      }

      .manager h2 {
        margin: 0;
        font-size: 1.2rem;
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      }

      .manager-meta {
        margin: 0.2rem 0 0;
        color: #4f5f67;
        font-size: 0.84rem;
        line-height: 1.4;
      }

      .manager-status {
        margin-top: 0.4rem;
        min-height: 1.2rem;
        color: #34444b;
        font-size: 0.84rem;
      }

      .manager-status.is-error {
        color: #8f1f10;
      }

      .manager-list {
        margin-top: 0.68rem;
        display: grid;
        gap: 0.48rem;
      }

      .manager-row {
        border: 1px solid var(--line);
        border-radius: 8px;
        background: #fff;
        padding: 0.6rem;
        display: grid;
        gap: 0.42rem;
      }

      .manager-title {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-wrap: wrap;
      }

      .manager-name {
        font-weight: 600;
      }

      .manager-slug {
        border: 1px solid rgba(17, 79, 85, 0.22);
        border-radius: 999px;
        padding: 0.08rem 0.36rem;
        font-family: "Consolas", "SFMono-Regular", Menlo, monospace;
        font-size: 0.72rem;
        color: #1a5860;
        background: rgba(17, 79, 85, 0.1);
      }

      .manager-badge {
        border-radius: 999px;
        border: 1px solid rgba(17, 79, 85, 0.24);
        padding: 0.08rem 0.34rem;
        font-size: 0.69rem;
        color: #2f4149;
        background: rgba(255, 255, 255, 0.9);
      }

      .manager-badge.active {
        border-color: rgba(15, 120, 88, 0.35);
        color: #11543f;
        background: rgba(15, 120, 88, 0.12);
      }

      .manager-badge.disabled {
        border-color: rgba(150, 100, 18, 0.4);
        color: #70470b;
        background: rgba(240, 170, 45, 0.2);
      }

      .manager-desc {
        margin: 0;
        color: #5a6b74;
        font-size: 0.82rem;
      }

      .manager-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.34rem;
      }

      .manager-btn {
        border: 1px solid rgba(17, 79, 85, 0.3);
        border-radius: 7px;
        background: #fff;
        color: #234f56;
        padding: 0.24rem 0.48rem;
        font-size: 0.74rem;
        cursor: pointer;
      }

      .manager-btn:hover {
        border-color: rgba(17, 79, 85, 0.5);
        background: rgba(17, 79, 85, 0.1);
      }

      .manager-btn.danger {
        border-color: rgba(160, 35, 20, 0.36);
        color: #7f2114;
        background: rgba(160, 35, 20, 0.08);
      }

      .manager-btn.danger:hover {
        border-color: rgba(160, 35, 20, 0.55);
        background: rgba(160, 35, 20, 0.14);
      }

      .manager-btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      @media (max-width: 980px) {
        .toolbar {
          grid-template-columns: 1fr;
        }

        .head {
          display: none;
        }

        .row {
          grid-template-columns: 1fr;
          gap: 0.62rem;
        }
      }

      @media (max-width: 700px) {
        .page {
          width: calc(100% - 1rem);
          margin: 1rem auto 2rem;
        }

        .hero {
          padding: 0.9rem;
        }

        .row {
          padding: 0.64rem;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }

      @keyframes lift-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header class="hero">
        <span class="hero-tag">Live Catalog</span>
        <h1>Web2API Recipes</h1>
        <p class="subtitle">
          Browse installed API recipes, filter quickly, then open or copy ready URLs. Use the
          repository section below to install and manage recipes. Endpoints labeled <code>q</code>
          require query input.
        </p>

        <div class="toolbar">
          <label>
            <input
              class="filter"
              id="filterInput"
              type="search"
              placeholder="Filter by site, slug, endpoint, or description"
              autocomplete="off"
            />
          </label>
          <label class="toggle">
            <input id="qOnlyToggle" type="checkbox" />
            Show only endpoints requiring q
          </label>
        </div>

        <div class="summary">
          <span class="pill"><strong id="visibleSites">{{ sites|length }}</strong> visible sites</span>
          <span class="pill"><strong id="visibleEndpoints">0</strong> visible endpoints</span>
          <span class="pill">pattern /&lt;slug&gt;/&lt;endpoint&gt;</span>
        </div>
      </header>

      {% if sites %}
      <section class="catalog" id="catalog">
        <div class="head" aria-hidden="true">
          <span>Site</span>
          <span>Endpoints</span>
          <span>Ready URLs</span>
        </div>

        {% for site in sites %}
        <article
          class="row"
          style="--row-index: {{ loop.index0 }};"
          data-site="{{ site.name|lower }} {{ site.slug|lower }} {{ site.description|default('', true)|lower }}"
        >
          <section class="site">
            <h2>{{ site.name }}</h2>
            <span class="slug">{{ site.slug }}</span>
            <p class="desc">{{ site.description }}</p>
          </section>

          <section class="endpoints">
            {% for ep in site.endpoints %}
            <div
              class="endpoint-item"
              data-endpoint-text="{{ ep.name|lower }} {{ ep.description|default('', true)|lower }}"
              data-requires-query="{% if ep.requires_query %}true{% else %}false{% endif %}"
            >
              <div class="endpoint-top">
                <p class="ep-name">{{ ep.name }}</p>
                {% if ep.requires_query %}
                <span class="q-badge">q</span>
                {% endif %}
              </div>
              {% if ep.description %}
              <p class="ep-desc">{{ ep.description }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </section>

          <section class="urls">
            {% for ep in site.endpoints %}
            {% if ep.requires_query %}
            {% set endpoint_url = ep.link ~ '?q=example&page=1' %}
            {% else %}
            {% set endpoint_url = ep.link ~ '?page=1' %}
            {% endif %}
            <div
              class="url-item"
              data-endpoint-text="{{ ep.name|lower }} {{ ep.description|default('', true)|lower }}"
              data-requires-query="{% if ep.requires_query %}true{% else %}false{% endif %}"
            >
              <a class="url" href="{{ endpoint_url }}">{{ endpoint_url }}</a>
              <button class="copy-btn" type="button" data-url="{{ endpoint_url }}">copy</button>
            </div>
            {% endfor %}
          </section>
        </article>
        {% endfor %}
      </section>

      <p class="empty is-hidden" id="noMatches">
        No recipes match your current filters.
      </p>
      {% else %}
      <div class="empty">
        No recipe APIs are installed yet. Use the repository section below to install one.
      </div>
      {% endif %}

      <section class="manager" id="repoManager">
        <div class="manager-top">
          <div>
            <h2>Recipe Repository</h2>
            <p class="manager-meta" id="managerSource">
              Browse catalog recipes and manage installed ones.
            </p>
          </div>
          <button class="manager-btn" id="managerReload" type="button">Refresh</button>
        </div>
        <p class="manager-status" id="managerStatus"></p>
        <div class="manager-list" id="managerList"></div>
      </section>
    </main>

    <script>
      (() => {
        const rows = Array.from(document.querySelectorAll(".row"));
        const filterInput = document.getElementById("filterInput");
        const qOnlyToggle = document.getElementById("qOnlyToggle");
        const visibleSites = document.getElementById("visibleSites");
        const visibleEndpoints = document.getElementById("visibleEndpoints");
        const noMatches = document.getElementById("noMatches");
        if (rows.length > 0 && filterInput && qOnlyToggle && visibleSites && visibleEndpoints && noMatches) {
          const normalize = (value) => value.trim().toLowerCase();

          const applyFilters = () => {
            const term = normalize(filterInput.value || "");
            const qOnly = qOnlyToggle.checked;

            let shownSites = 0;
            let shownEndpoints = 0;

            rows.forEach((row) => {
              const siteText = row.dataset.site || "";
              const siteMatches = term === "" || siteText.includes(term);

              const endpointItems = Array.from(row.querySelectorAll(".endpoint-item"));
              const urlItems = Array.from(row.querySelectorAll(".url-item"));

              let rowVisibleCount = 0;

              endpointItems.forEach((endpointItem, index) => {
                const endpointText = endpointItem.dataset.endpointText || "";
                const requiresQuery = endpointItem.dataset.requiresQuery === "true";

                const matchesToggle = !qOnly || requiresQuery;
                const matchesTerm = term === "" || siteMatches || endpointText.includes(term);
                const isVisible = matchesToggle && matchesTerm;

                endpointItem.classList.toggle("is-hidden", !isVisible);
                if (urlItems[index]) {
                  urlItems[index].classList.toggle("is-hidden", !isVisible);
                }

                if (isVisible) {
                  rowVisibleCount += 1;
                }
              });

              const rowVisible = rowVisibleCount > 0;
              row.classList.toggle("is-hidden", !rowVisible);

              if (rowVisible) {
                shownSites += 1;
                shownEndpoints += rowVisibleCount;
              }
            });

            visibleSites.textContent = String(shownSites);
            visibleEndpoints.textContent = String(shownEndpoints);
            noMatches.classList.toggle("is-hidden", shownSites > 0);
          };

          filterInput.addEventListener("input", applyFilters);
          qOnlyToggle.addEventListener("change", applyFilters);

          document.querySelectorAll(".copy-btn").forEach((button) => {
            button.addEventListener("click", async () => {
              const relative = button.dataset.url || "";
              const absolute = `${window.location.origin}${relative}`;

              try {
                await navigator.clipboard.writeText(absolute);
                const original = button.textContent;
                button.textContent = "copied";
                window.setTimeout(() => {
                  button.textContent = original;
                }, 1100);
              } catch (_error) {
                button.textContent = "failed";
                window.setTimeout(() => {
                  button.textContent = "copy";
                }, 1100);
              }
            });
          });

          applyFilters();
        }

        const managerSource = document.getElementById("managerSource");
        const managerStatus = document.getElementById("managerStatus");
        const managerList = document.getElementById("managerList");
        const managerReload = document.getElementById("managerReload");
        if (!managerSource || !managerStatus || !managerList || !managerReload) {
          return;
        }

        let busy = false;

        const setStatus = (message, { error = false } = {}) => {
          managerStatus.textContent = message;
          managerStatus.classList.toggle("is-error", error);
        };

        const readError = async (response) => {
          try {
            const payload = await response.json();
            if (typeof payload.detail === "string" && payload.detail) {
              return payload.detail;
            }
            return JSON.stringify(payload);
          } catch (_error) {
            return `${response.status} ${response.statusText}`;
          }
        };

        const actionButton = ({ label, onClick, danger = false }) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `manager-btn${danger ? " danger" : ""}`;
          button.disabled = busy;
          button.textContent = label;
          button.addEventListener("click", onClick);
          return button;
        };

        const runAction = async ({ url, label }) => {
          if (busy) {
            return;
          }
          busy = true;
          setStatus(`${label}...`);
          try {
            const response = await fetch(url, { method: "POST" });
            if (!response.ok) {
              throw new Error(await readError(response));
            }
            setStatus(`${label} complete. Reloading...`);
            window.location.reload();
          } catch (error) {
            const message = error instanceof Error ? error.message : "request failed";
            setStatus(message, { error: true });
            busy = false;
          }
        };

        const renderCatalog = (payload) => {
          managerList.replaceChildren();
          const source = payload.catalog_source || {};
          const sourceParts = [source.source || "-"];
          if (source.ref) {
            sourceParts.push(`ref: ${source.ref}`);
          }
          if (source.path) {
            sourceParts.push(`path: ${source.path}`);
          }
          managerSource.textContent = `Source: ${sourceParts.join(" Â· ")}`;

          if (payload.catalog_error) {
            setStatus(`Catalog unavailable: ${payload.catalog_error}`, { error: true });
          }

          const catalog = Array.isArray(payload.catalog) ? payload.catalog : [];
          const installed = Array.isArray(payload.installed) ? payload.installed : [];
          const catalogSlugs = new Set(catalog.map((entry) => String(entry.slug || "")));

          const localOnlyInstalled = installed.filter((entry) => {
            const slug = String(entry.slug || "");
            return Boolean(entry.has_recipe) && slug !== "" && !catalogSlugs.has(slug);
          });

          const renderRecipeRow = (entry, { catalogName = null } = {}) => {
            const slugRaw = String(entry.slug || entry.name || "");
            if (!slugRaw) {
              return;
            }
            const installedValue = Boolean(entry.installed);
            const managedValue = Boolean(entry.managed);
            const enabledValue = Boolean(entry.enabled);
            const originValue = String(entry.origin || (installedValue ? "unmanaged" : "catalog"));

            const row = document.createElement("article");
            row.className = "manager-row";

            const title = document.createElement("div");
            title.className = "manager-title";

            const name = document.createElement("span");
            name.className = "manager-name";
            name.textContent = String(catalogName || entry.name || slugRaw);
            title.append(name);

            const slug = document.createElement("span");
            slug.className = "manager-slug";
            slug.textContent = slugRaw;
            title.append(slug);

            const trustBadge = document.createElement("span");
            trustBadge.className = "manager-badge";
            trustBadge.textContent = entry.trusted ? "trusted" : "untrusted";
            title.append(trustBadge);

            const originBadge = document.createElement("span");
            originBadge.className = "manager-badge";
            originBadge.textContent = `origin:${originValue}`;
            title.append(originBadge);

            if (installedValue) {
              const stateBadge = document.createElement("span");
              stateBadge.className = `manager-badge ${enabledValue ? "active" : "disabled"}`;
              stateBadge.textContent = enabledValue ? "installed" : "installed/disabled";
              title.append(stateBadge);
            }

            row.append(title);

            const desc = document.createElement("p");
            desc.className = "manager-desc";
            desc.textContent = String(entry.description || "No description.");
            row.append(desc);

            const actions = document.createElement("div");
            actions.className = "manager-actions";
            const slugValue = encodeURIComponent(slugRaw);
            const nameValue = encodeURIComponent(String(catalogName || entry.name || ""));

            if (!installedValue) {
              actions.append(
                actionButton({
                  label: "Install",
                  onClick: () =>
                    runAction({
                      url: `/api/recipes/manage/install/${nameValue}`,
                      label: `Installing ${entry.slug || entry.name}`,
                    }),
                })
              );
            } else {
              actions.append(
                actionButton({
                  label: enabledValue ? "Disable" : "Enable",
                  onClick: () =>
                    runAction({
                      url: enabledValue
                        ? `/api/recipes/manage/disable/${slugValue}`
                        : `/api/recipes/manage/enable/${slugValue}`,
                      label: `${enabledValue ? "Disabling" : "Enabling"} ${slugRaw}`,
                    }),
                })
              );
              if (managedValue) {
                actions.append(
                  actionButton({
                    label: "Update",
                    onClick: () =>
                      runAction({
                        url: `/api/recipes/manage/update/${slugValue}`,
                        label: `Updating ${slugRaw}`,
                      }),
                  })
                );
              }
              actions.append(
                actionButton({
                  label: managedValue ? "Uninstall" : "Uninstall (force)",
                  danger: true,
                  onClick: () =>
                    runAction({
                      url: managedValue
                        ? `/api/recipes/manage/uninstall/${slugValue}`
                        : `/api/recipes/manage/uninstall/${slugValue}?force=true`,
                      label: `Uninstalling ${slugRaw}`,
                    }),
                })
              );
            }

            row.append(actions);
            managerList.append(row);
          };

          if (catalog.length === 0 && localOnlyInstalled.length === 0) {
            const empty = document.createElement("p");
            empty.className = "manager-desc";
            empty.textContent = "No catalog recipes found and no local recipes installed.";
            managerList.append(empty);
            return;
          }

          if (!payload.catalog_error) {
            setStatus(
              `${catalog.length} catalog recipes loaded, ${localOnlyInstalled.length} local-only installed.`
            );
          }

          catalog.forEach((entry) => {
            renderRecipeRow(entry, { catalogName: entry.name });
          });

          localOnlyInstalled.forEach((entry) => {
            renderRecipeRow(
              {
                name: entry.slug,
                slug: entry.slug,
                description: "Installed locally and not listed in current catalog source.",
                trusted: entry.trusted,
                installed: true,
                enabled: entry.enabled,
                managed: entry.managed,
                origin: entry.origin,
              },
              { catalogName: null }
            );
          });
        };

        const loadCatalog = async () => {
          setStatus("Loading catalog...");
          try {
            const response = await fetch("/api/recipes/manage");
            if (!response.ok) {
              throw new Error(await readError(response));
            }
            const payload = await response.json();
            renderCatalog(payload);
          } catch (error) {
            const message = error instanceof Error ? error.message : "catalog load failed";
            setStatus(message, { error: true });
          }
        };

        managerReload.addEventListener("click", () => {
          if (busy) {
            return;
          }
          void loadCatalog();
        });

        void loadCatalog();
      })();
    </script>
  </body>
</html>
